<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wardriving Tool</title>
    <!-- Add Bootstrap CSS link -->
    <link rel="stylesheet" href="Utils/static/bootstrap-5.3.1-dist/css/bootstrap.min.css">
    <!-- Add Chart.js -->
    <script src="Utils/static/charts.js"></script>
</head>

<body>
    <div class="modal" id="interfaceModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="interfaceForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Select Interface</h5>
                    </div>
                    <div class="modal-body">
                        <p>Please select the interface you want to use:</p>
                        <select class="form-select" id="interfaceSelect" aria-label="Default select example">
                            {% for interface_name, interface_data in deviceInfo.interfaces.items() %}
                                <option value="{{ interface_data.idx }}">{{ interface_data.interfaceName }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Navbar -->
    <nav class="navbar navbar-expand-sm navbar-dark navbar-text bg-dark" style="padding: 0%;">
        <div class="container-fluid">
            <img src="Utils/static/Kuro2ToneRedNOBG.png" style="height: 95px; width: 95px">
            <a class="navbar-brand" href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">Wardriving Tool</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics" style="font-weight: 1000;">Analytics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/output">Output</a>
                    </li>
                </ul>
            </div>
            <h5 class="my-auto" id="selectedInterface" value="{{ deviceInfo['interfaceInfo']['idx'] }}" >Using Interface: {{ deviceInfo["interfaceInfo"]["name"] }}</h5>
        </div>
    </nav>

    <div class="container-fluid">
    <div class="row">
        <!-- Left half column - Device Analytics -->
        <div class="col-sm-12 col-lg-3 text-black p-4">
            <h2>Device Analytics</h2>
            <!-- Temperature Chart -->
            <div class="col-12">
                <canvas id="temperatureChart"></canvas>
                <h5 id="temp">CPU Temp: </h5>
            </div>
            <!-- CPU Usage Chart -->
            <div class="col-12">
                <canvas id="cpuUsageChart"></canvas>
                <h5 id="cpu">CPU Usage: </h5>
            </div>
        </div>

        <!-- Middle column - Networks Chart -->
        <div class="col-sm-12 col-lg-3 text-black p-4">
            <h2>Networks Encryption</h2>
            <canvas id="encryptionPieChartInRange"></canvas>
            <canvas id="encryptionChartSaved"></canvas>
        </div>

        <!-- Right column - Network Info -->
        <div class="col-sm-12 col-lg-2 text-black p-4">
            <h2>Networks Info</h2>
            <h4 id="networkCount">In Range: </h4>
            <h4 id="totalNetworks">Total Found: </h4>
            <h3>In Range</h3>
            <h4 id="unknownNetworks">Unknown:</h4>
            <h4 id="wepNetworks">WEP:</h4>
            <h4 id="wpaNetworks">WPA:</h4>
            <h4 id="wpa2Networks">WPA2:</h4>
            <h3>Total Count</h3>
            <h4 id="unknownNetworksSaved">Unknown:</h4>
            <h4 id="wepNetworksSaved">Total WEP:</h4>
            <h4 id="wpaNetworksSaved">Total WPA:</h4>
            <h4 id="wpa2NetworksSaved">Total WPA2:</h4>
        </div>

        <!-- Middle column - Strongest Signals Bar Chart -->
        <div class="col-sm-12 col-lg-4 text-black p-4">
            <h2>Strongest Signals</h2>
            <button id="toggleSSIDsBtn" onclick="toggleSSIDs()" class="btn bg-primary-subtle">Hide SSIDs</button>

            <canvas id="strongestSignalsChart"></canvas>
        </div>

        <div class="row">
            <!-- Bottom left column - Additional Info -->
            <div class="col-md-6 bg-secondary text-white p-4">
                <h3>Additional Info</h3>
                <!-- Add additional information here -->
            </div>

            <!-- Bottom right column - Additional Info -->
            <div class="col-md-6 bg-secondary text-white p-4">
                <h3>Additional Info</h3>
                <!-- Add additional information here -->
            </div>
        </div>
    </div>
    <!-- Add Bootstrap JS and Popper.js -->
    <script src="Utils/static/bootstrap-5.3.1-dist/js/bootstrap.bundle.min.js"></script>
    <!-- Add Chart.js -->
    <script  src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    const MAX_DATA_POINTS = 20;
    const temperatureChart = document.getElementById('temperatureChart').getContext('2d');
    const cpuUsageChart = document.getElementById('cpuUsageChart').getContext('2d');
        


    const temperatureChartInstance = new Chart(temperatureChart, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperature',
                data: [],
                borderColor: 'red',
                fill: false,
                

            }]
        },
        options: {
            animation: {
                duration: 1 // Set animation duration to 0 to disable animation
            }
        }
    });

    const cpuUsageChartInstance = new Chart(cpuUsageChart, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU Usage',
                data: [],
                borderColor: 'blue',
                fill: false,

            }]
        },
        options: {
            animation: {
                duration: 1 // Set animation duration to 0 to disable animation
            }
        }
    });


    // Initialize the bar chart
    const strongestSignalsBarChart = new Chart(strongestSignalsChart, {
        type: 'bar',
        data: {
            labels: [], // Will contain SSIDs of nearest networks
            datasets: [{
                label: 'Signal Strength (0 highest, -100 lowest))',
                data: [], // Will contain signal strength values
                backgroundColor: 'blue', // Customize the bar color
            }]
        },
        options: {
            indexAxis: 'x', // Display bars on the bottom and go up based on signal strength
            scales: {
                y: {
                   
                    title: {
                        display: true,
                        text: 'Network SSID'
                    }
                },
                x: {
                    beginAtZero: true, // Display highest signal strength at the top
                    title: {
                        display: true,
                        text: 'Signal Strength'
                    }
                }
            },

    
        }
    });

    // Initialize the pie chart for encryption in range
    const encryptionPieChartInRangeCanvas = document.getElementById('encryptionPieChartInRange');
    const encryptionPieChartInRange = new Chart(encryptionPieChartInRangeCanvas, {
        type: 'pie',
        data: {
            labels: ['WEP', 'WPA', 'WPA2', 'Unknown'],
            datasets: [{
                label: 'In Range',
                data: [],
                backgroundColor: ['red', 'blue', 'green', 'purple', 'gray'], // Customize the colors
            }]
        },
        options: {
            aspectRatio: 2, // Adjust this value to control the chart's aspect ratio
            // Other options can be added here as needed
        }
    });

    // Initialize the pie chart for total encryption
    const encryptionPieChartTotalCanvas = document.getElementById('encryptionChartSaved');
    const encryptionPieChartTotal = new Chart(encryptionPieChartTotalCanvas, {
        type: 'pie',
        data: {
            labels: ['WEP', 'WPA', 'WPA2', 'Unknown'],
            datasets: [{
                label: 'In Total',
                data: [],
                backgroundColor: ['red', 'blue', 'green', 'purple', 'gray'], // Customize the colors
            }]
        },
        options: {
            aspectRatio: 2, // Adjust this value to control the chart's aspect ratio
            // Other options can be added here as needed
        }
    });


    async function updateCharts() {
        const response = await fetch('/data');
        const data = await response.json();
        document.getElementById('temp').innerHTML = "CPU Temp: " + data.temperature;
        document.getElementById('cpu').innerHTML = "CPU Usage: " + data.cpuUsage;

        // Update temperature chart
        temperatureChartInstance.data.labels.push(new Date().toLocaleTimeString());
        temperatureChartInstance.data.datasets[0].data.push(data.temperature);
        temperatureChartInstance.update();

        // Update CPU usage chart
        cpuUsageChartInstance.data.labels.push(new Date().toLocaleTimeString());
        cpuUsageChartInstance.data.datasets[0].data.push(data.cpuUsage);
        cpuUsageChartInstance.update();

        // Limit the number of data points to the defined maximum
        if (temperatureChartInstance.data.datasets[0].data.length > MAX_DATA_POINTS) {
            temperatureChartInstance.data.datasets[0].data.shift();
            temperatureChartInstance.data.labels.shift(); // Also shift corresponding label
        }

        if (cpuUsageChartInstance.data.datasets[0].data.length > MAX_DATA_POINTS) {
            cpuUsageChartInstance.data.datasets[0].data.shift();
            cpuUsageChartInstance.data.labels.shift(); // Also shift corresponding label
        }


    }

    updateCharts();
    setInterval(updateCharts, 1000);




// Function to fetch and update the encryption data for the pie chart
async function updateNetworkCharts() {



    const response = await fetch('/networks');
    const data = await response.json();

    // Update the pie chart data
    const wpaCount = data.WPA || 0;
    const wpa2Count = data.WPA2 || 0;
    const wepCount = data.WEP || 0;
    const unknownCount = data.unknownEnc || 0;

    // Update the pie chart data
    const wpaCountSaved = data.savedWPA || 0;
    const wpa2CountSaved = data.savedWPA2 || 0;
    const wepCountSaved = data.savedWEP || 0;
    const unknownCountSaved = data.unknownEnc || 0;


    // Update pie chart data
    encryptionPieChartInRange.data.datasets[0].data = [wepCount, wpaCount, wpa2Count, unknownCount];
    encryptionPieChartInRange.data.labels = [
        `WEP (${wepCount})`,
        `WPA (${wpaCount})`,
        `WPA2 (${wpa2Count})`,
        `Unknown (${unknownCount})`
    ];
    encryptionPieChartInRange.update();

    // Update pie chart data
    encryptionPieChartTotal.data.datasets[0].data = [wepCountSaved, wpaCountSaved, wpa2CountSaved, unknownCountSaved];
    encryptionPieChartTotal.data.labels = [
        `WEP (${wepCountSaved})`,
        `WPA (${wpaCountSaved})`,
        `WPA2 (${wpa2CountSaved})`,
        `Unknown (${unknownCountSaved})`
    ];
    encryptionPieChartTotal.update();

    // Update the content of HTML elements with the received data
    document.getElementById('networkCount').innerText = `In Range: ${data.networkCount}`;
    document.getElementById('totalNetworks').innerText = `Total Networks: ${data.savedNetworksCount}`;
    document.getElementById('unknownNetworks').innerText = `Unknown: ${data.unknownEnc}`;
    document.getElementById('wepNetworks').innerText = `WEP: ${data.WEP}`;
    document.getElementById('wpaNetworks').innerText = `WPA: ${data.WPA}`;
    document.getElementById('wpa2Networks').innerText = `WPA2: ${data.WPA2}`;
    document.getElementById('unknownNetworksSaved').innerText = `Unknown: ${data.unknownSaved}`;
    document.getElementById('wepNetworksSaved').innerText = `WEP: ${data.savedWEP}`;
    document.getElementById('wpaNetworksSaved').innerText = `WPA: ${data.savedWPA}`;
    document.getElementById('wpa2NetworksSaved').innerText = `WPA2: ${data.savedWPA2}`;

    // Update the strongest signals bar chart data
    const nearestNetworks = Object.values(data.networks) || [];
    const sortedNetworks = nearestNetworks.sort((a, b) => b.signalStrength - a.signalStrength);
    const limitedNetworks = sortedNetworks.slice(0, 10); // Limit to max 10 data points

    const signalData = limitedNetworks.map(network => (showSSIDs ? network.signalStrength : 0));
    const ssidData = limitedNetworks.map(network => (showSSIDs ? network.ssid : '')); // Update this line


    // Update chart data
    strongestSignalsBarChart.data.labels = ssidData;
    strongestSignalsBarChart.data.datasets[0].data = signalData;
    strongestSignalsBarChart.update();
}


// Initial call to update the chart and set interval for updates
updateNetworkCharts();
setInterval(updateNetworkCharts, 7000); // Update every 7 seconds


let showSSIDs = true; // Initial state

function toggleSSIDs() {
    showSSIDs = !showSSIDs; // Toggle the state

    updateNetworkCharts(); // Call the chart update function
}


function toggleSSIDs() {
    showSSIDs = !showSSIDs; // Toggle the state
    // Check if the container element exists before trying to access its style
    const container = document.getElementById('strongestSignalsContainer');
    

    if (showSSIDs) {
        document.getElementById('toggleSSIDsBtn').innerText = 'Hide SSIDs';
    } else {
        document.getElementById('toggleSSIDsBtn').innerText = 'Show SSIDs';
    }
    updateNetworkCharts(); // Call the chart update function
}



document.addEventListener("DOMContentLoaded", function () {
    const interfaceForm = document.getElementById('interfaceForm');
    const interfaceSelect = document.getElementById('interfaceSelect');
    const selectedInterfaceLabel = document.getElementById('selectedInterface');
    // Check if an interface is already chosen
    const currentInterface = selectedInterfaceLabel.getAttribute('value'); // Use getAttribute to get the value | Return None if not set
    console.log(currentInterface);
    if (currentInterface == "None") {
        // If no interface is chosen, show the modal
        const interfaceModal = new bootstrap.Modal(document.getElementById('interfaceModal'));
        interfaceModal.show();
        // Add submit event listener to the form
        interfaceForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission
            const selectedInterfaceIdx = interfaceSelect.value;
            const selectedInterfaceName = interfaceSelect.options[interfaceSelect.selectedIndex].text; // Get selected option text
            // Create JSON payload
            const payload = {
                interfaceIdx: selectedInterfaceIdx,
                interfaceName: selectedInterfaceName
            };
            // Make API call using fetch
            fetch('/setInterface', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                // Handle API response if needed
                console.log(data);
                // Close the modal after submitting
                interfaceModal.hide();
                selectedInterfaceLabel.textContent = `Using Interface: ${selectedInterfaceName}`;
            })
            .catch(error => {
                // Handle error if needed
                console.error('Error:', error);
            });
        });
    } else {
        // If an interface is already chosen, update the label
        selectedInterfaceLabel.textContent = `Using Interface: ${selectedInterfaceLabel.textContent}`;
    }
    });
    </script>
</body>
</html>
